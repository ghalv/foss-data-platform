<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Streaming Dashboard - FOSS Data Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .service-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .btn {
            font-weight: 500;
            border-radius: 0.5rem;
        }
        .display-5 {
            color: #2c3e50;
        }
        .lead {
            color: #6c757d;
        }
        .live-indicator {
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .topic-status {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: bold;
            text-align: center;
        }
        .data-stream {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .consumer-group {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #0d6efd;
        }
        .lag-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .lag-low { background: #28a745; }
        .lag-medium { background: #ffc107; }
        .lag-high { background: #dc3545; }
        .throughput-meter {
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            height: 8px;
            border-radius: 4px;
            margin: 0.5rem 0;
            position: relative;
        }
        .throughput-indicator {
            background: #333;
            width: 4px;
            height: 16px;
            border-radius: 2px;
            position: absolute;
            top: -4px;
            transition: left 0.3s ease;
        }
        .chart-container {
            height: 300px !important;
            max-height: 300px !important;
        }
        .chart-container canvas {
            max-height: 300px !important;
        }
        .alert-item {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid #dc3545;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database"></i> FOSS Data Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a class="nav-link" href="/pipeline-management"><i class="fas fa-cogs"></i> Pipelines</a>
                <a class="nav-link" href="/data-browser"><i class="fas fa-search"></i> Data</a>
                <a class="nav-link" href="/health"><i class="fas fa-heartbeat"></i> Health</a>
                <a class="nav-link" href="/chat"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 mb-2">
                    <i class="fas fa-stream text-primary"></i> Real-time Streaming Dashboard
                </h1>
                <p class="lead mb-0">Monitor live data streams and Kafka topics</p>
            </div>
        </div>

        <!-- Streaming Controls -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-play-circle"></i> Streaming Controls
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success" id="startStreaming">
                                <i class="fas fa-play"></i> Start Streaming
                            </button>
                            <button type="button" class="btn btn-outline-danger" id="stopStreaming" disabled>
                                <i class="fas fa-stop"></i> Stop Streaming
                            </button>
                            <button type="button" class="btn btn-outline-warning" id="pauseStream">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="clearData">
                                <i class="fas fa-trash"></i> Clear Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Streaming Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card service-card">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                        <h4 class="card-title" id="totalMessages">0</h4>
                        <p class="card-text text-muted">Total Messages</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card service-card">
                    <div class="card-body text-center">
                        <i class="fas fa-tachometer-alt fa-2x text-success mb-2"></i>
                        <h4 class="card-title" id="throughput">0</h4>
                        <p class="card-text text-muted">Messages/sec</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card service-card">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h4 class="card-title" id="alertCount">0</h4>
                        <p class="card-text text-muted">Active Alerts</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card service-card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-info mb-2"></i>
                        <h4 class="card-title" id="uptime">0s</h4>
                        <p class="card-text text-muted">Uptime</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Status and Consumer Groups -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Topic Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="topicStatus">
                            <!-- Topic status will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users"></i> Consumer Groups
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="consumerGroups">
                            <!-- Consumer groups will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Charts -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line"></i> Message Flow
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="messageFlowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie"></i> Topic Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="topicDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Live Data Stream and Alerts -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-stream"></i> Live Data Stream
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="liveDataStream" class="data-stream">
                            <!-- Live data will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bell"></i> Real-time Alerts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="alertsContainer">
                            <!-- Alerts will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Throughput Monitoring -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt"></i> Throughput Monitoring
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Raw Data</h6>
                                <div class="throughput-meter">
                                    <div class="throughput-indicator" id="rawThroughput"></div>
                                </div>
                                <small class="text-muted" id="rawThroughputValue">0 msg/s</small>
                            </div>
                            <div class="col-md-4">
                                <h6>Processed Data</h6>
                                <div class="throughput-meter">
                                    <div class="throughput-indicator" id="processedThroughput"></div>
                                </div>
                                <small class="text-muted" id="processedThroughputValue">0 msg/s</small>
                            </div>
                            <div class="col-md-4">
                                <h6>Alerts</h6>
                                <div class="throughput-meter">
                                    <div class="throughput-indicator" id="alertThroughput"></div>
                                </div>
                                <small class="text-muted" id="alertThroughputValue">0 msg/s</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row">
            <div class="col-12 text-center text-muted">
                <small>
                    <i class="fas fa-code"></i> Built with modern data engineering best practices<br>
                    FOSS Data Platform - Enterprise-grade open source solution
                </small>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let messageFlowChart, topicDistributionChart;
        let streamingActive = false;
        let messageCounts = { raw: 0, processed: 0, alerts: 0 };
        let throughputData = { raw: [], processed: [], alerts: [] };
        let alertCount = 0;
        let startTime = Date.now();
        let streamingProcessId = null;

        // Initialize charts
        function initializeCharts() {
            // Message Flow Chart
            const messageFlowCtx = document.getElementById('messageFlowChart').getContext('2d');
            messageFlowChart = new Chart(messageFlowCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Raw Data',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Processed Data',
                        data: [],
                        borderColor: '#198754',
                        backgroundColor: 'rgba(25, 135, 84, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Topic Distribution Chart
            const topicDistributionCtx = document.getElementById('topicDistributionChart').getContext('2d');
            topicDistributionChart = new Chart(topicDistributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Raw Data', 'Processed Data', 'Alerts'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#0d6efd', '#198754', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Update topic status
        async function updateTopicStatus() {
            try {
                const response = await fetch('/api/streaming/topics');
                const topics = await response.json();
                
                const statusContainer = document.getElementById('topicStatus');
                statusContainer.innerHTML = '';
                
                topics.forEach(topic => {
                    const statusClass = topic.status === 'healthy' ? 'status-healthy' : 'status-warning';
                    const statusElement = document.createElement('div');
                    statusElement.className = 'mb-2';
                    statusElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span><strong>${topic.name}</strong></span>
                            <span class="topic-status ${statusClass}">${topic.status}</span>
                        </div>
                        <small class="text-muted">Messages: ${topic.messages} | Partitions: ${topic.partitions}</small>
                    `;
                    statusContainer.appendChild(statusElement);
                });
            } catch (error) {
                console.error('Error updating topic status:', error);
            }
        }

        // Update consumer groups
        async function updateConsumerGroups() {
            try {
                const response = await fetch('/api/streaming/consumers');
                const consumers = await response.json();
                
                const groupsContainer = document.getElementById('consumerGroups');
                groupsContainer.innerHTML = '';
                
                consumers.forEach(consumer => {
                    const lagClass = consumer.lag < 5 ? 'lag-low' : consumer.lag < 20 ? 'lag-medium' : 'lag-high';
                    const groupElement = document.createElement('div');
                    groupElement.className = 'consumer-group';
                    groupElement.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span><strong>${consumer.group}</strong></span>
                            <span class="lag-indicator ${lagClass}"></span>
                        </div>
                        <small class="text-muted">Topic: ${consumer.topic} | Lag: ${consumer.lag}</small>
                    `;
                    groupsContainer.appendChild(groupElement);
                });
            } catch (error) {
                console.error('Error updating consumer groups:', error);
            }
        }

        // Update live data stream
        async function updateLiveDataStream() {
            try {
                const response = await fetch('/api/streaming/live-data');
                const data = await response.json();
                
                const streamContainer = document.getElementById('liveDataStream');
                
                // Add new messages to the top
                data.messages.slice(0, 5).forEach(message => {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'mb-2 p-2 bg-white rounded';
                    messageElement.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-${message.type === 'raw' ? 'primary' : message.type === 'processed' ? 'success' : 'danger'}">${message.type}</span>
                            <small class="text-muted">${new Date(message.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div class="mt-1">
                            <strong>${message.data.location}</strong> - ${message.data.utilization_rate}% full
                        </div>
                    `;
                    streamContainer.insertBefore(messageElement, streamContainer.firstChild);
                });
                
                // Keep only last 10 messages
                while (streamContainer.children.length > 10) {
                    streamContainer.removeChild(streamContainer.lastChild);
                }
                
                // Update message counts
                messageCounts = data.counts;
                document.getElementById('totalMessages').textContent = 
                    messageCounts.raw + messageCounts.processed + messageCounts.alerts;
                
            } catch (error) {
                console.error('Error updating live data stream:', error);
            }
        }

        // Update charts
        function updateCharts() {
            const now = new Date().toLocaleTimeString();
            
            // Update message flow chart
            messageFlowChart.data.labels.push(now);
            messageFlowChart.data.datasets[0].data.push(messageCounts.raw);
            messageFlowChart.data.datasets[1].data.push(messageCounts.processed);
            
            // Keep only last 10 data points
            if (messageFlowChart.data.labels.length > 10) {
                messageFlowChart.data.labels.shift();
                messageFlowChart.data.datasets[0].data.shift();
                messageFlowChart.data.datasets[1].data.shift();
            }
            
            messageFlowChart.update();
            
            // Update topic distribution chart
            topicDistributionChart.data.datasets[0].data = [
                messageCounts.raw,
                messageCounts.processed,
                messageCounts.alerts
            ];
            topicDistributionChart.update();
        }

        // Update throughput indicators
        function updateThroughput() {
            const rawThroughput = Math.min(messageCounts.raw / 10, 100);
            const processedThroughput = Math.min(messageCounts.processed / 10, 100);
            const alertThroughput = Math.min(messageCounts.alerts / 10, 100);
            
            document.getElementById('rawThroughput').style.left = rawThroughput + '%';
            document.getElementById('processedThroughput').style.left = processedThroughput + '%';
            document.getElementById('alertThroughput').style.left = alertThroughput + '%';
            
            document.getElementById('rawThroughputValue').textContent = `${Math.round(rawThroughput)} msg/s`;
            document.getElementById('processedThroughputValue').textContent = `${Math.round(processedThroughput)} msg/s`;
            document.getElementById('alertThroughputValue').textContent = `${Math.round(alertThroughput)} msg/s`;
            
            document.getElementById('throughput').textContent = Math.round((rawThroughput + processedThroughput + alertThroughput) / 3);
        }

        // Update uptime
        function updateUptime() {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            
            if (hours > 0) {
                document.getElementById('uptime').textContent = `${hours}h ${minutes}m ${seconds}s`;
            } else if (minutes > 0) {
                document.getElementById('uptime').textContent = `${minutes}m ${seconds}s`;
            } else {
                document.getElementById('uptime').textContent = `${seconds}s`;
            }
        }

        // Add alert
        function addAlert(message, type = 'warning') {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertElement = document.createElement('div');
            alertElement.className = 'alert-item';
            alertElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span><strong>${message}</strong></span>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;
            alertsContainer.insertBefore(alertElement, alertsContainer.firstChild);
            
            // Keep only last 5 alerts
            while (alertsContainer.children.length > 5) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
            
            alertCount++;
            document.getElementById('alertCount').textContent = alertCount;
        }

        // Event listeners
        document.getElementById('startStreaming').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/streaming/start', { method: 'POST' });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    streamingActive = true;
                    this.disabled = true;
                    this.className = 'btn btn-outline-success';
                    document.getElementById('stopStreaming').disabled = false;
                    document.getElementById('stopStreaming').className = 'btn btn-danger';
                    addAlert('Streaming started successfully', 'success');
                    startTime = Date.now(); // Reset uptime
                } else {
                    addAlert('Failed to start streaming: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error starting streaming:', error);
                addAlert('Error starting streaming: ' + error.message, 'danger');
            }
        });

        document.getElementById('stopStreaming').addEventListener('click', async function() {
            try {
                const response = await fetch('/api/streaming/stop', { method: 'POST' });
                const data = await response.json();
                if (response.ok && data.status === 'success') {
                    streamingActive = false;
                    this.disabled = true;
                    this.className = 'btn btn-outline-danger';
                    document.getElementById('startStreaming').disabled = false;
                    document.getElementById('startStreaming').className = 'btn btn-success';
                    addAlert('Streaming stopped', 'info');
                } else {
                    addAlert('Failed to stop streaming: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                console.error('Error stopping streaming:', error);
                addAlert('Error stopping streaming: ' + error.message, 'danger');
            }
        });

        document.getElementById('clearData').addEventListener('click', function() {
            document.getElementById('liveDataStream').innerHTML = '';
            document.getElementById('alertsContainer').innerHTML = '';
            alertCount = 0;
            document.getElementById('alertCount').textContent = '0';
            addAlert('Data cleared', 'info');
        });

        document.getElementById('pauseStream').addEventListener('click', function() {
            if (streamingActive) {
                streamingActive = false;
                this.innerHTML = '<i class="fas fa-play"></i> Resume';
                this.className = 'btn btn-warning';
                addAlert('Streaming paused', 'warning');
            } else {
                streamingActive = true;
                this.innerHTML = '<i class="fas fa-pause"></i> Pause';
                this.className = 'btn btn-outline-warning';
                addAlert('Streaming resumed', 'success');
            }
        });

        // Check streaming status
        async function checkStreamingStatus() {
            try {
                const response = await fetch('/api/streaming/status');
                const data = await response.json();
                if (response.ok) {
                    // Update button states based on actual streaming status
                    const startBtn = document.getElementById('startStreaming');
                    const stopBtn = document.getElementById('stopStreaming');
                    
                    if (data.overall_status === 'healthy' && data.kafka && data.kafka.healthy) {
                        streamingActive = true;
                        startBtn.disabled = true;
                        startBtn.className = 'btn btn-outline-success';
                        stopBtn.disabled = false;
                        stopBtn.className = 'btn btn-danger';
                    } else {
                        streamingActive = false;
                        startBtn.disabled = false;
                        startBtn.className = 'btn btn-success';
                        stopBtn.disabled = true;
                        stopBtn.className = 'btn btn-outline-danger';
                    }
                }
            } catch (error) {
                console.error('Error checking streaming status:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            
            // Check initial streaming status
            checkStreamingStatus();
            
            // Start periodic updates
            setInterval(updateTopicStatus, 5000);
            setInterval(updateConsumerGroups, 10000);
            setInterval(updateLiveDataStream, 2000);
            setInterval(updateCharts, 5000);
            setInterval(updateThroughput, 1000);
            setInterval(updateUptime, 1000);
            setInterval(checkStreamingStatus, 10000); // Check status every 10 seconds
            
            // Initial updates
            updateTopicStatus();
            updateConsumerGroups();
            
            // Simulate some initial data for demo
            setTimeout(() => {
                addAlert('Dashboard initialized and ready for streaming data', 'success');
            }, 1000);
        });
    </script>
</body>
</html>