<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Management - FOSS Data Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pipeline-card {
            transition: transform 0.2s;
        }
        .pipeline-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-stopped { background-color: #6c757d; }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .pipeline-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .pipeline-row:hover {
            background-color: #f8f9fa;
        }
        .pipeline-row td:last-child {
            cursor: default;
        }
        .pipeline-row td:last-child * {
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database"></i> FOSS Data Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a class="nav-link active" href="/pipeline-management"><i class="fas fa-cogs"></i> Pipelines</a>
                <a class="nav-link" href="/data-browser"><i class="fas fa-search"></i> Data</a>
                <a class="nav-link" href="/health"><i class="fas fa-heartbeat"></i> Health</a>
                <a class="nav-link" href="/chat"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-5">
                    <i class="fas fa-cogs text-primary"></i>
                    Pipeline Management
                </h1>
                <p class="lead text-muted">Manage, configure, and monitor all data pipelines</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPipelineModal">
                    <i class="fas fa-plus"></i> Add Pipeline
                </button>
            </div>
        </div>

        <!-- Pipeline Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-2" id="totalPipelines">0</h3>
                        <p class="mb-0">Total Pipelines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="activePipelines">0</h3>
                        <p class="mb-0">Running</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="failedPipelines">0</h3>
                        <p class="mb-0">Warnings</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="successRate">0%</h3>
                        <p class="mb-0">Success Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Registry -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list"></i> Pipeline Registry
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Pipeline</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Last Run</th>
                                        <th>Models</th>
                                        <th>Success Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pipelinesTableBody">
                                    <!-- Pipeline rows will be loaded here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Recent Executions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for execution in recent_executions %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ execution.pipeline_name }}</strong>
                                    <br><small class="text-muted">{{ execution.timestamp }}</small>
                                </div>
                                <span class="badge bg-{{ execution.status_color }}">{{ execution.status }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Recent Alerts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for alert in recent_alerts %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ alert.pipeline_name }}</strong>
                                    <br><small class="text-muted">{{ alert.message }}</small>
                                </div>
                                <span class="badge bg-{{ alert.severity }}">{{ alert.severity }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pipeline Modal -->
    <div class="modal fade" id="addPipelineModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Pipeline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPipelineForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Name</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="dbt">dbt</option>
                                        <option value="airflow">Apache Airflow</option>
                                        <option value="custom">Custom Script</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Directory</label>
                                    <input type="text" class="form-control" name="project_dir" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Environment</label>
                                    <select class="form-select" name="target" required>
                                        <option value="dev">Development</option>
                                        <option value="staging">Staging</option>
                                        <option value="prod">Production</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule (Cron Expression)</label>
                            <input type="text" class="form-control" name="schedule" placeholder="0 0 * * * (daily at midnight)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePipeline()">Add Pipeline</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Pipeline Modal -->
    <div class="modal fade" id="editPipelineModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pipeline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPipelineForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Name</label>
                                    <input type="text" class="form-control" id="editPipelineName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Type</label>
                                    <select class="form-select" id="editPipelineType" name="type" required>
                                        <option value="dbt">dbt</option>
                                        <option value="airflow">Apache Airflow</option>
                                        <option value="custom">Custom Script</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editPipelineDescription" name="description" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Directory</label>
                                    <input type="text" class="form-control" id="editProjectDir" name="project_dir" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Environment</label>
                                    <select class="form-select" id="editTarget" name="target" required>
                                        <option value="dev">Development</option>
                                        <option value="staging">Staging</option>
                                        <option value="prod">Production</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule (Cron Expression)</label>
                            <input type="text" class="form-control" id="editSchedule" name="schedule" placeholder="0 0 * * * (daily at midnight)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updatePipeline()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load real pipeline data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPipelineData();
            loadPipelineStats();
        });

        function loadPipelineData() {
            fetch('/api/pipeline/list')
                .then(response => response.json())
                .then(data => {
                    if (data.pipelines) {
                        displayPipelines(data.pipelines);
                    }
                })
                .catch(error => {
                    console.error('Error loading pipeline data:', error);
                    displayPipelines([]);
                });
        }

        function loadPipelineStats() {
            fetch('/api/pipeline/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.total_pipelines !== undefined) {
                        document.getElementById('totalPipelines').textContent = data.total_pipelines;
                    }
                    if (data.active_pipelines !== undefined) {
                        document.getElementById('activePipelines').textContent = data.active_pipelines;
                    }
                    if (data.failed_pipelines !== undefined) {
                        document.getElementById('failedPipelines').textContent = data.failed_pipelines;
                    }
                    if (data.success_rate !== undefined) {
                        document.getElementById('successRate').textContent = (data.success_rate * 100).toFixed(1) + '%';
                    }
                })
                .catch(error => {
                    console.error('Error loading pipeline stats:', error);
                });
        }

        function displayPipelines(pipelines) {
            const tbody = document.getElementById('pipelinesTableBody');
            
            if (pipelines.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            No pipelines found. Create your first pipeline to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            pipelines.forEach(pipeline => {
                const statusClass = getStatusClass(pipeline.status);
                const lastRun = pipeline.last_run ? new Date(pipeline.last_run).toLocaleString() : 'Never';
                const nextRun = pipeline.next_run ? new Date(pipeline.next_run).toLocaleString() : 'Not scheduled';
                
                html += `
                    <tr class="pipeline-row" onclick="viewPipeline('${pipeline.name}')" style="cursor: pointer;">
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-project-diagram text-primary me-2"></i>
                                <div>
                                    <strong>${pipeline.name}</strong>
                                    <br><small class="text-muted">${pipeline.description || 'No description'}</small>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge bg-info">${pipeline.type || 'dbt'}</span></td>
                        <td><span class="badge bg-${statusClass}">${pipeline.status}</span></td>
                        <td>${lastRun}</td>
                        <td>5</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" style="width: 100%">
                                    100%
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" onclick="event.stopPropagation();">
                                <button class="btn btn-outline-primary" onclick="viewPipeline('${pipeline.name}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="runPipeline('${pipeline.name}')">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="controlPipeline('${pipeline.name}')">
                                    <i class="fas fa-cogs"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="editPipeline('${pipeline.name}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deletePipeline('${pipeline.name}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'running': return 'primary';
                case 'success': return 'success';
                case 'failed': return 'danger';
                case 'pending': return 'warning';
                case 'stopped': return 'secondary';
                default: return 'info';
            }
        }

        function viewPipeline(pipelineName) {
            window.open(`/pipeline/${pipelineName}`, '_blank');
        }

        function controlPipeline(pipelineName) {
            window.open(`/pipeline-control?pipeline=${pipelineName}`, '_blank');
        }

        function runPipeline(pipelineName) {
            fetch('/api/pipeline/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pipeline: pipelineName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Pipeline ${pipelineName} started successfully`, 'success');
                    loadPipelineData(); // Refresh the list
                } else {
                    showNotification(`Failed to start pipeline: ${data.error}`, 'danger');
                }
            })
            .catch(error => {
                console.error('Error running pipeline:', error);
                showNotification('Error running pipeline', 'danger');
            });
        }

        function editPipeline(pipelineName) {
            // Show edit modal
            document.getElementById('editPipelineName').value = pipelineName;
            document.getElementById('editPipelineType').value = 'dbt';
            document.getElementById('editSchedule').value = '0 0 * * *';
            
            const editModal = new bootstrap.Modal(document.getElementById('editPipelineModal'));
            editModal.show();
        }

        function deletePipeline(pipelineName) {
            if (confirm(`Are you sure you want to delete pipeline "${pipelineName}"?`)) {
                fetch('/api/pipeline/delete', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pipeline: pipelineName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(`Pipeline ${pipelineName} deleted successfully`, 'success');
                        loadPipelineData(); // Refresh the list
                    } else {
                        showNotification(`Failed to delete pipeline: ${data.error}`, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error deleting pipeline:', error);
                    showNotification('Error deleting pipeline', 'danger');
                });
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
