<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Management - FOSS Data Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .pipeline-card {
            transition: transform 0.2s;
        }
        .pipeline-card:hover {
            transform: translateY(-2px);
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-running { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-stopped { background-color: #6c757d; }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .pipeline-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .bg-gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .pipeline-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .pipeline-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
            border-color: rgba(0,123,255,0.2);
        }

        .pipeline-card .card-header {
            border-bottom: none;
            border-radius: 8px 8px 0 0 !important;
        }

        .pipeline-card .card-footer {
            border-top: 1px solid rgba(0,0,0,0.05);
            border-radius: 0 0 8px 8px !important;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
        }

        .status-success { background-color: #28a745; }
        .status-running { background-color: #007bff; animation: pulse 2s infinite; }
        .status-failed { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        .status-unknown { background-color: #6c757d; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .metric-divider {
            border-right: 1px solid #dee2e6;
        }

        .pipeline-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Timeline styles for phase visualization */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e9ecef;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 15px;
        }
        .timeline-item.current .timeline-marker {
            box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
        }
        .timeline-marker {
            position: absolute;
            left: -22px;
            top: 5px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #6c757d;
            border: 2px solid #fff;
            z-index: 1;
        }
        .timeline-marker.completed {
            background: #28a745;
        }
        .timeline-marker.running {
            background: #007bff;
            animation: pulse 2s infinite;
        }
        .timeline-marker.failed {
            background: #dc3545;
        }
        .timeline-marker.pending {
            background: #ffc107;
        }
        .timeline-content {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
        }

        /* Medallion Architecture Flow Styles */
        .medallion-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 200px;
            position: relative;
            overflow-x: auto;
        }

        .flow-connector {
            flex: 1;
            height: 3px;
            background: linear-gradient(90deg, #e9ecef 0%, #dee2e6 50%, #e9ecef 100%);
            position: relative;
            margin: 0 10px;
        }

        .flow-connector.active {
            background: linear-gradient(90deg, #28a745 0%, #20c997 50%, #28a745 100%);
        }

        .flow-connector.processing {
            background: linear-gradient(90deg, #007bff 0%, #6610f2 50%, #007bff 100%);
            animation: flow-pulse 2s infinite;
        }

        @keyframes flow-pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .flow-step {
            flex: 0 0 auto;
            text-align: center;
            min-width: 160px;
            position: relative;
        }

        .step-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            position: relative;
            transition: all 0.3s ease;
            border: 3px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .step-node.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #a0522d 100%);
        }

        .step-node.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #a8a8a8 100%);
        }

        .step-node.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        }

        .step-node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .step-node.processing {
            animation: node-processing 1.5s ease-in-out infinite;
        }

        @keyframes node-processing {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .step-description {
            font-size: 0.75rem;
            color: #6c757d;
            max-width: 140px;
            margin: 0 auto;
            line-height: 1.2;
        }

        .step-metrics {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            font-size: 0.7rem;
            border: 1px solid #e9ecef;
        }

        .metric-value {
            font-weight: bold;
            color: #495057;
        }

        .metric-label {
            color: #6c757d;
            font-size: 0.6rem;
        }

        .flow-status-indicator {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .flow-status-indicator.success { background-color: #28a745; }
        .flow-status-indicator.warning { background-color: #ffc107; }
        .flow-status-indicator.error { background-color: #dc3545; }
        .flow-status-indicator.processing { background-color: #007bff; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .medallion-flow {
                flex-direction: column;
                gap: 20px;
            }

            .flow-connector {
                width: 3px;
                height: 40px;
                margin: 10px auto;
                background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 50%, #e9ecef 100%);
            }

            .flow-step {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database"></i> FOSS Data Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a class="nav-link active" href="/pipeline-management"><i class="fas fa-cogs"></i> Pipelines</a>
                <a class="nav-link" href="/data-browser"><i class="fas fa-search"></i> Data</a>
                <a class="nav-link" href="/health"><i class="fas fa-heartbeat"></i> Health</a>
                <a class="nav-link" href="/chat"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-5">
                    <i class="fas fa-cogs text-primary"></i>
                    Pipeline Management
                </h1>
                <p class="lead text-muted">Manage, configure, and monitor all data pipelines</p>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPipelineModal">
                    <i class="fas fa-plus"></i> Add Pipeline
                </button>
            </div>
        </div>

        <!-- Pipeline Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <h3 class="mb-2" id="totalPipelines">0</h3>
                        <p class="mb-0">Total Pipelines</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="activePipelines">0</h3>
                        <p class="mb-0">Running</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="failedPipelines">0</h3>
                        <p class="mb-0">Warnings</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center border-0 shadow-sm" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); color: white;">
                    <div class="card-body">
                        <h3 class="mb-2" id="successRate">0%</h3>
                        <p class="mb-0">Success Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-rocket"></i> Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <button class="btn btn-outline-primary w-100 mb-2" onclick="runPipeline()">
                                    <i class="fas fa-play"></i> Run Pipeline
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-success w-100 mb-2" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Generate Report
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-info w-100 mb-2" onclick="viewDataQuality()">
                                    <i class="fas fa-search"></i> Data Quality
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-warning w-100 mb-2" onclick="window.open('http://localhost:8888/lab', '_blank')">
                                    <i class="fab fa-jupyter"></i> JupyterLab
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pipeline Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-stream"></i> Pipeline Overview
                        </h5>
                        <div class="d-flex align-items-center">
                            <small class="text-white-50 me-3">Last updated: <span id="lastUpdateTime">Loading...</span></small>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                <label class="form-check-label text-white" for="autoRefresh">
                                    Auto-refresh
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="pipelineLifecycleContainer">
                            <!-- Pipeline overview will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cleanup Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-broom"></i> Cleanup Management
                        </h5>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-light" id="refreshCleanupBtn" title="Refresh Cleanup Stats">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#cleanupConfigModal" title="Cleanup Settings">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h4 class="text-primary" id="cleanupFilesCount">-</h4>
                                        <small class="text-muted">Files to Clean</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h4 class="text-success" id="cleanupSpaceSaved">-</h4>
                                        <small class="text-muted">Space Saved</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <h4 class="text-warning" id="cleanupLastRun">-</h4>
                                        <small class="text-muted">Last Cleanup</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light border-0">
                                    <div class="card-body text-center">
                                        <div class="btn-group-vertical">
                                            <button class="btn btn-outline-primary btn-sm" id="dryRunCleanupBtn">
                                                <i class="fas fa-eye"></i> Dry Run
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" id="runCleanupBtn">
                                                <i class="fas fa-play"></i> Run Cleanup
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-list"></i> Retention Policies</h6>
                                <div id="retentionPoliciesContainer">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        Loading policies...
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-history"></i> Recent Cleanup History</h6>
                                <div id="cleanupHistoryContainer">
                                    <div class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="sr-only">Loading...</span>
                                        </div>
                                        Loading history...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-history"></i> Recent Executions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for execution in recent_executions %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ execution.pipeline_name }}</strong>
                                    <br><small class="text-muted">{{ execution.timestamp }}</small>
                                </div>
                                <span class="badge bg-{{ execution.status_color }}">{{ execution.status }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Recent Alerts
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for alert in recent_alerts %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ alert.pipeline_name }}</strong>
                                    <br><small class="text-muted">{{ alert.message }}</small>
                                </div>
                                <span class="badge bg-{{ alert.severity }}">{{ alert.severity }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Pipeline Modal -->
    <div class="modal fade" id="addPipelineModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Pipeline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPipelineForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Name</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Type</label>
                                    <select class="form-select" name="type" required>
                                        <option value="dbt">dbt</option>
                                        <option value="airflow">Apache Airflow</option>
                                        <option value="custom">Custom Script</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Directory</label>
                                    <input type="text" class="form-control" name="project_dir" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Environment</label>
                                    <select class="form-select" name="target" required>
                                        <option value="dev">Development</option>
                                        <option value="staging">Staging</option>
                                        <option value="prod">Production</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule (Cron Expression)</label>
                            <input type="text" class="form-control" name="schedule" placeholder="0 0 * * * (daily at midnight)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePipeline()">Add Pipeline</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Pipeline Modal -->
    <div class="modal fade" id="editPipelineModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Pipeline</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPipelineForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Name</label>
                                    <input type="text" class="form-control" id="editPipelineName" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Pipeline Type</label>
                                    <select class="form-select" id="editPipelineType" name="type" required>
                                        <option value="dbt">dbt</option>
                                        <option value="airflow">Apache Airflow</option>
                                        <option value="custom">Custom Script</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editPipelineDescription" name="description" rows="2"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Project Directory</label>
                                    <input type="text" class="form-control" id="editProjectDir" name="project_dir" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Target Environment</label>
                                    <select class="form-select" id="editTarget" name="target" required>
                                        <option value="dev">Development</option>
                                        <option value="staging">Staging</option>
                                        <option value="prod">Production</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Schedule (Cron Expression)</label>
                            <input type="text" class="form-control" id="editSchedule" name="schedule" placeholder="0 0 * * * (daily at midnight)">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updatePipeline()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cleanup Configuration Modal -->
    <div class="modal fade" id="cleanupConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-broom"></i> Cleanup Configuration
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Configure retention policies for automatic cleanup of old pipeline operations and logs.
                    </div>

                    <div id="cleanupPoliciesForm">
                        <!-- Policies will be loaded here -->
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i> Safety Features
                            </h6>
                            <ul class="list-unstyled small">
                                <li><i class="fas fa-check text-success"></i> Automatic backups before deletion</li>
                                <li><i class="fas fa-check text-success"></i> Dry-run mode for testing</li>
                                <li><i class="fas fa-check text-success"></i> Comprehensive audit logging</li>
                                <li><i class="fas fa-check text-success"></i> Configurable retention periods</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">
                                <i class="fas fa-chart-bar"></i> Expected Impact
                            </h6>
                            <div id="cleanupImpactStats">
                                <small class="text-muted">Load cleanup statistics to see impact...</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveCleanupPolicies()">
                        <i class="fas fa-save"></i> Save Policies
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Real-time pipeline lifecycle monitoring
        let refreshInterval;
        let lastOperationsData = {};

        document.addEventListener('DOMContentLoaded', function() {
            loadPipelineLifecycle();
            startAutoRefresh();

            // Handle auto-refresh toggle
            document.getElementById('autoRefresh').addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        });

        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            refreshInterval = setInterval(() => {
                loadPipelineLifecycle();
            }, 15000); // Refresh every 15 seconds (reduced from 3 seconds for performance)
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        // Pipeline refresh variables

        function generateMedallionFlowHTML(pipelines, operations) {
            // Define the medallion architecture steps
            const medallionSteps = [
                {
                    id: 'ingestion',
                    layer: 'bronze',
                    label: 'API Ingestion',
                    description: 'Fetch live parking data from Stavanger API',
                    icon: 'fas fa-cloud-download-alt',
                    status: 'completed'
                },
                {
                    id: 'delta_load',
                    layer: 'bronze',
                    label: 'Delta Load',
                    description: 'Incremental data loading with Iceberg MERGE',
                    icon: 'fas fa-exchange-alt',
                    status: 'completed'
                },
                {
                    id: 'bronze_landing',
                    layer: 'bronze',
                    label: 'Bronze Landing',
                    description: 'Raw data with minimal transformation',
                    icon: 'fas fa-database',
                    status: 'completed'
                },
                {
                    id: 'data_quality',
                    layer: 'bronze',
                    label: 'Quality Audit',
                    description: 'Data validation and anomaly detection',
                    icon: 'fas fa-search',
                    status: 'completed'
                },
                {
                    id: 'silver_entities',
                    layer: 'silver',
                    label: 'Silver Entities',
                    description: 'Cleaned parking locations & master data',
                    icon: 'fas fa-map-marker-alt',
                    status: 'completed'
                },
                {
                    id: 'silver_facts',
                    layer: 'silver',
                    label: 'Silver Facts',
                    description: 'Validated occupancy measurements',
                    icon: 'fas fa-chart-line',
                    status: 'completed'
                },
                {
                    id: 'gold_reports',
                    layer: 'gold',
                    label: 'Gold Reports',
                    description: 'Business intelligence & KPIs',
                    icon: 'fas fa-chart-bar',
                    status: 'completed'
                },
                {
                    id: 'gold_dashboards',
                    layer: 'gold',
                    label: 'Gold Dashboards',
                    description: 'Real-time analytics & monitoring',
                    icon: 'fas fa-tachometer-alt',
                    status: 'completed'
                },
                {
                    id: 'gold_analytics',
                    layer: 'gold',
                    label: 'Gold Analytics',
                    description: 'Predictive features & ML-ready data',
                    icon: 'fas fa-brain',
                    status: 'completed'
                }
            ];

            // Determine current processing status based on operations
            const currentOperation = operations.find(op => op.status === 'running' || op.status === 'pending');
            let currentStepIndex = -1;

            if (currentOperation) {
                // Map operation steps to medallion steps
                const stepMapping = {
                    'Seed live data': 0, // ingestion
                    'Run dbt models': 3, // data_quality
                    'Generate reports': 6  // gold_reports
                };

                const stepName = currentOperation.description || currentOperation.name || '';
                for (const [key, index] of Object.entries(stepMapping)) {
                    if (stepName.includes(key)) {
                        currentStepIndex = index;
                        break;
                    }
                }
            }

            // Generate HTML for the flow
            let html = '<div class="medallion-flow">';

            medallionSteps.forEach((step, index) => {
                // Determine step status
                let stepStatus = 'pending';
                let connectorClass = '';
                let nodeClass = step.layer;

                if (index < currentStepIndex) {
                    stepStatus = 'completed';
                    connectorClass = 'active';
                } else if (index === currentStepIndex) {
                    stepStatus = 'processing';
                    connectorClass = 'processing';
                    nodeClass += ' processing';
                } else if (pipelines.length > 0 && operations.some(op => op.status === 'success')) {
                    stepStatus = 'completed';
                    connectorClass = 'active';
                }

                // Add connector (except for first step)
                if (index > 0) {
                    html += `<div class="flow-connector ${connectorClass}"></div>`;
                }

                // Add step
                html += `
                    <div class="flow-step">
                        <div class="step-node ${nodeClass}" title="${step.description}">
                            <i class="${step.icon}"></i>
                            <div class="flow-status-indicator ${stepStatus}"></div>
                        </div>
                        <div class="step-label">${step.label}</div>
                        <div class="step-description">${step.description}</div>
                        <div class="step-metrics">
                            <div class="metric-value">${getStepMetric(step.id, pipelines, operations)}</div>
                            <div class="metric-label">${getStepMetricLabel(step.id)}</div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Add legend
            html += `
                <div class="mt-4 pt-3 border-top">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="step-node bronze" style="width: 20px; height: 20px; margin-right: 8px;"></div>
                                <span class="small text-muted">Bronze Layer - Raw Data</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="step-node silver" style="width: 20px; height: 20px; margin-right: 8px;"></div>
                                <span class="small text-muted">Silver Layer - Clean Data</span>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center justify-content-center mb-2">
                                <div class="step-node gold" style="width: 20px; height: 20px; margin-right: 8px;"></div>
                                <span class="small text-muted">Gold Layer - Business Analytics</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        function getStepMetric(stepId, pipelines, operations) {
            // Return relevant metrics for each step
            switch (stepId) {
                case 'ingestion':
                    const totalOperations = operations.length;
                    return totalOperations > 0 ? totalOperations : '0';
                case 'bronze_landing':
                    return pipelines.length > 0 ? '✓' : '○';
                case 'data_quality':
                    const successOps = operations.filter(op => op.status === 'success').length;
                    return successOps > 0 ? successOps : '○';
                case 'silver_entities':
                    return pipelines.length > 0 ? pipelines.length : '○';
                case 'silver_facts':
                    return operations.filter(op => op.status === 'success').length > 0 ? '✓' : '○';
                case 'gold_reports':
                case 'gold_dashboards':
                case 'gold_analytics':
                    return operations.filter(op => op.status === 'success').length > 0 ? '✓' : '○';
                default:
                    return '○';
            }
        }

        function getStepMetricLabel(stepId) {
            switch (stepId) {
                case 'ingestion': return 'API calls';
                case 'bronze_landing': return 'Data loaded';
                case 'data_quality': return 'Quality checks';
                case 'silver_entities': return 'Entities';
                case 'silver_facts': return 'Facts processed';
                case 'gold_reports': return 'Reports ready';
                case 'gold_dashboards': return 'Dashboards live';
                case 'gold_analytics': return 'ML features';
                default: return 'Status';
            }
        }

        function updateFlowLastRefresh() {
            const now = new Date();
            document.getElementById('flowLastUpdate').textContent =
                now.toLocaleTimeString();
        }

        function updateLastRefresh() {
            console.log('updateLastRefresh called');
            const now = new Date();
            const element = document.getElementById('lastUpdate');
            if (element) {
                element.textContent = now.toLocaleTimeString();
                console.log('Updated lastUpdate element:', now.toLocaleTimeString());
            } else {
                console.log('lastUpdate element not found');
            }
        }

        // Debug: Log when functions are loaded
        console.log('Pipeline management functions loaded:', {
            updateLastRefresh: typeof updateLastRefresh,
            updateFlowLastRefresh: typeof updateFlowLastRefresh,
            loadPipelineLifecycle: typeof loadPipelineLifecycle
        });

        // Pipeline management functions
        function runPipeline(pipelineId) {
            if (confirm(`Run pipeline: ${pipelineId}?`)) {
                fetch(`/api/pipeline/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pipeline: pipelineId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Pipeline started successfully!');
                        loadPipelineLifecycle(); // Refresh the data
                    } else {
                        alert('Failed to start pipeline: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error starting pipeline: ' + error.message);
                });
            }
        }

        function generateReport() {
            window.open('/data-browser', '_blank');
        }

        function viewDataQuality() {
            window.open('/data-browser', '_blank');
        }

        function openJupyterForPipeline(pipelineId) {
            const jupyterUrl = `http://localhost:8888/lab/tree/${pipelineId}`;
            window.open(jupyterUrl, '_blank');
        }

        function viewPipelineDetail(pipelineId) {
            // Navigate to pipeline detail page with medallion architecture flow
            window.location.href = `/pipeline-detail/${pipelineId}`;
        }

        function savePipeline() {
            alert('Pipeline creation is handled through the CLI. Use: ./tools/cli/create-pipeline.sh');
        }

        function updatePipeline() {
            alert('Pipeline updates are managed through configuration files. Edit the YAML files in config/pipelines/');
        }

        function saveCleanupPolicies() {
            alert('Cleanup policies are configured in the pipeline YAML files under the cleanup section.');
        }

        // Integrate medallion flow with existing lifecycle loading
        function loadPipelineLifecycle() {
            // Load multiple data sources for comprehensive monitoring
            Promise.all([
                fetch('/api/pipeline/list').then(r => r.json()),
                fetch('/api/pipeline/stats').then(r => r.json()),
                fetch('/api/operations/status').then(r => r.json()).catch(() => ({operations: []}))
            ])
            .then(([pipelineData, statsData, operationsData]) => {
                updateStats(statsData);
                updatePipelineLifecycle(pipelineData, operationsData);
                updateLastRefresh();

                // Pipeline data loaded successfully
            })
            .catch(error => {
                console.error('Error loading pipeline lifecycle:', error);
                document.getElementById('pipelineLifecycleContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error loading pipeline data: ${error.message}
                    </div>
                `;
            });
        }

        function updateStats(data) {
            document.getElementById('totalPipelines').textContent = data.total_pipelines || 0;
            document.getElementById('activePipelines').textContent = data.active_pipelines || 0;
            document.getElementById('failedPipelines').textContent = data.failed_pipelines || 0;
            document.getElementById('successRate').textContent = data.success_rate ?
                (data.success_rate * 100).toFixed(1) + '%' : '0%';
        }

        function updatePipelineLifecycle(pipelineData, operationsData) {
            const container = document.getElementById('pipelineLifecycleContainer');

            if (!pipelineData.success) {
                container.innerHTML = '<div class="alert alert-warning">Unable to load pipeline data</div>';
                return;
            }

            const html = generateLifecycleHTML(pipelineData.pipelines || [], operationsData.operations || []);
            container.innerHTML = html;
        }

        function generateLifecycleHTML(pipelines, operations) {
            if (pipelines.length === 0) {
                return `
                    <div class="text-center py-5">
                        <i class="fas fa-database fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Pipelines Configured</h5>
                        <p class="text-muted mb-3">Get started by adding your first data pipeline</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPipelineModal">
                            <i class="fas fa-plus"></i> Add Your First Pipeline
                        </button>
                    </div>
                `;
            }

            // Sort pipelines by status (running first, then recently run)
            pipelines.sort((a, b) => {
                const aOps = operations.filter(op => op.pipeline_name === a.name);
                const bOps = operations.filter(op => op.pipeline_name === b.name);
                const aLast = aOps.sort((x, y) => y.start_time - x.start_time)[0];
                const bLast = bOps.sort((x, y) => y.start_time - x.start_time)[0];

                // Running pipelines first
                if (aLast?.status === 'running' && bLast?.status !== 'running') return -1;
                if (bLast?.status === 'running' && aLast?.status !== 'running') return 1;

                // Then by most recent activity
                return (bLast?.start_time || 0) - (aLast?.start_time || 0);
            });

            let html = `<div class="row">`;

            pipelines.forEach(pipeline => {
                // Find the most recent operation for this pipeline
                const pipelineOperations = operations.filter(op => op.pipeline_name === pipeline.name);
                const lastOperation = pipelineOperations.sort((a, b) => b.start_time - a.start_time)[0] || {};

                // Find last successful run
                const lastSuccess = pipelineOperations
                    .filter(op => op.status === 'success')
                    .sort((a, b) => b.start_time - a.start_time)[0];

                // Find last failed run
                const lastFail = pipelineOperations
                    .filter(op => op.status === 'failed')
                    .sort((a, b) => b.start_time - a.start_time)[0];

                // Calculate success rate
                const totalRuns = pipelineOperations.length;
                const successfulRuns = pipelineOperations.filter(op => op.status === 'success').length;
                const successRate = totalRuns > 0 ? Math.round((successfulRuns / totalRuns) * 100) : 0;

                // Get status information
                const statusInfo = getStatusInfo(lastOperation.status || 'unknown');
                const lastRunTime = lastOperation.start_time ? new Date(lastOperation.start_time).toLocaleString() : 'Never';
                const lastFailTime = lastFail ? new Date(lastFail.start_time).toLocaleString() : 'Never';

                // Pipeline description (mock for now, could come from pipeline config)
                const description = getPipelineDescription(pipeline.name);

                html += `
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card h-100 border-0 shadow-sm pipeline-card" onclick="viewPipelineDetail('${pipeline.id}')" style="cursor: pointer;">
                            <div class="card-header ${statusInfo.headerClass} text-white d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="${statusInfo.icon} me-2"></i>
                                    <div>
                                        <h6 class="mb-0 fw-bold">${pipeline.name}</h6>
                                        <small class="opacity-75">${description}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="badge ${statusInfo.badgeClass} mb-1">${statusInfo.label}</div>
                                    <div class="small opacity-75">${successRate}% success</div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="border-end">
                                            <div class="h5 mb-0 text-primary">${totalRuns}</div>
                                            <small class="text-muted">Total Runs</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border-end">
                                            <div class="h5 mb-0 text-success">${successfulRuns}</div>
                                            <small class="text-muted">Success</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="h5 mb-0 text-warning">${pipelineOperations.filter(op => op.status === 'running').length}</div>
                                        <small class="text-muted">Running</small>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <small class="text-muted">Last Run</small>
                                        <small class="text-muted">${lastRunTime}</small>
                                    </div>
                                    ${lastFail ? `
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-danger">Last Fail</small>
                                        <small class="text-danger">${lastFailTime}</small>
                                    </div>
                                    ` : ''}
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-primary btn-sm flex-fill" onclick="event.stopPropagation(); runPipeline('${pipeline.id}')">
                                        <i class="fas fa-play"></i> Run
                                    </button>
                                    <button class="btn btn-outline-info btn-sm flex-fill" onclick="event.stopPropagation(); viewPipelineDetail('${pipeline.id}')">
                                        <i class="fas fa-eye"></i> Details
                                    </button>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-code-branch"></i> ${pipeline.type || 'dbt'}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> ${pipeline.schedule || 'Manual'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `</div>`;
            return html;
        }

        function getStatusInfo(status) {
            const statusMap = {
                'success': {
                    label: 'Success',
                    icon: 'fas fa-check-circle',
                    headerClass: 'bg-success',
                    badgeClass: 'bg-success'
                },
                'running': {
                    label: 'Running',
                    icon: 'fas fa-play-circle',
                    headerClass: 'bg-primary',
                    badgeClass: 'bg-primary'
                },
                'failed': {
                    label: 'Failed',
                    icon: 'fas fa-exclamation-triangle',
                    headerClass: 'bg-danger',
                    badgeClass: 'bg-danger'
                },
                'pending': {
                    label: 'Pending',
                    icon: 'fas fa-clock',
                    headerClass: 'bg-warning',
                    badgeClass: 'bg-warning'
                },
                'unknown': {
                    label: 'Unknown',
                    icon: 'fas fa-question-circle',
                    headerClass: 'bg-secondary',
                    badgeClass: 'bg-secondary'
                }
            };
            return statusMap[status] || statusMap['unknown'];
        }

        function getPipelineDescription(pipelineName) {
            // Mock descriptions for different pipeline types
            const descriptions = {
                'stavanger_parking': 'Real-time parking utilization and business intelligence',
                'customer_analytics': 'Customer behavior analysis and segmentation',
                'sales_reporting': 'Sales performance and revenue analytics',
                'inventory_management': 'Stock levels and supply chain optimization',
                'marketing_campaigns': 'Campaign performance and ROI analysis',
                'financial_reporting': 'Financial statements and budget analysis',
                'user_engagement': 'User interaction patterns and engagement metrics',
                'product_analytics': 'Product usage analytics and feature adoption',
                'supply_chain': 'Supply chain optimization and logistics tracking',
                'quality_assurance': 'Data quality monitoring and validation checks',
                'compliance_reporting': 'Regulatory compliance and audit reporting'
            };

            // If we have a specific description, use it
            if (descriptions[pipelineName]) {
                return descriptions[pipelineName];
            }

            // Otherwise generate a generic description based on name
            const nameParts = pipelineName.replace(/_/g, ' ').split(' ');
            return `${nameParts.map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')} Pipeline`;
        }

        function getStatusBadge(status) {
            const statusMap = {
                'success': '<span class="badge bg-success">Success</span>',
                'running': '<span class="badge bg-primary">Running</span>',
                'failed': '<span class="badge bg-danger">Failed</span>',
                'pending': '<span class="badge bg-warning">Pending</span>',
                'unknown': '<span class="badge bg-secondary">Unknown</span>'
            };
            return statusMap[status] || statusMap['unknown'];
        }

        function updateLastRefresh() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const timeElement = document.getElementById('lastUpdateTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        function runPipeline(pipelineId) {
            if (confirm(`Run pipeline: ${pipelineId}?`)) {
                fetch(`/api/pipeline/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pipeline: pipelineId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Pipeline started successfully!');
                        loadPipelineLifecycle(); // Refresh the data
                    } else {
                        alert('Failed to start pipeline: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    alert('Error starting pipeline: ' + error.message);
                });
            }
        }

        function viewPipeline(pipelineId) {
            window.location.href = `/pipeline-control?pipeline=${pipelineId}`;
        }

        // Simplified pipeline management - keeping it fast and focused

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired - initializing pipeline management');

            // Initialize existing pipeline lifecycle
            console.log('Calling loadPipelineLifecycle');
            loadPipelineLifecycle();

            // Pipeline management initialized
            console.log('Pipeline management page loaded successfully');
        });

        // Clean, simplified pipeline management - no complex functions needed
    </script>
</body>
</html>
