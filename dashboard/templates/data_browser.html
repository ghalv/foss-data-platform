<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Browser - FOSS Data Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <style>
        .CodeMirror {
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
        }
        .query-results {
            max-height: 400px;
            overflow-y: auto;
        }
        .table-responsive {
            border-radius: 0.375rem;
        }
        .schema-browser {
            max-height: 300px;
            overflow-y: auto;
        }
        .catalog-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .catalog-item:hover {
            background-color: #f8f9fa;
        }
        .catalog-item.active {
            background-color: #e3f2fd;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database"></i> FOSS Data Platform
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/"><i class="fas fa-home"></i> Dashboard</a>
                <a class="nav-link" href="/pipeline-management"><i class="fas fa-cogs"></i> Pipelines</a>
                <a class="nav-link active" href="/data-browser"><i class="fas fa-search"></i> Data</a>
                <a class="nav-link" href="/health"><i class="fas fa-heartbeat"></i> Health</a>
                <a class="nav-link" href="/chat"><i class="fas fa-comments"></i> Chat</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="display-5">
                    <i class="fas fa-search text-primary"></i>
                    Iceberg Data Explorer
                </h1>
                <p class="lead text-muted">Explore your data lake with full Iceberg integration, metadata discovery, and advanced analytics</p>
            </div>
        </div>

        <!-- Data Navigation Menu -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <a href="/storage-management" class="text-decoration-none">
                                    <div class="p-3 border rounded h-100">
                                        <i class="fas fa-database fa-2x text-primary mb-2"></i>
                                        <h6>Storage Management</h6>
                                        <small class="text-muted">MinIO & Iceberg</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/bi-dashboard" class="text-decoration-none">
                                    <div class="p-3 border rounded h-100">
                                        <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                                        <h6>BI Dashboard</h6>
                                        <small class="text-muted">Business Intelligence</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/streaming" class="text-decoration-none">
                                    <div class="p-3 border rounded h-100">
                                        <i class="fas fa-stream fa-2x text-warning mb-2"></i>
                                        <h6>Real-time Streaming</h6>
                                        <small class="text-muted">Kafka & Flink monitoring</small>
                                    </div>
                                </a>
                            </div>
                            <div class="col-md-3">
                                <a href="/api/quality/run-checks" class="text-decoration-none" target="_blank">
                                    <div class="p-3 border rounded h-100">
                                        <i class="fas fa-shield-alt fa-2x text-danger mb-2"></i>
                                        <h6>Data Quality</h6>
                                        <small class="text-muted">Run quality checks</small>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help Note -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle"></i>
                    <strong>Data Explorer Guide:</strong> Explore your Iceberg data lake with full metadata, partitioning, and analytics capabilities.
                    Use the dynamic schema browser to discover catalogs, schemas, and tables. Click on tables for detailed metadata and statistics.
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Panel: Schema Browser -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-sitemap"></i> Schema Browser
                            <button class="btn btn-sm btn-outline-light float-end" onclick="refreshCatalogTree()">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </h5>
                    </div>
                    <div class="card-body schema-browser">
                        <div id="catalog-tree">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading catalogs...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Metadata Panel -->
                <div class="card mt-3" id="metadata-panel" style="display: none;">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle"></i> Table Metadata
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="metadata-content">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading metadata...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Query Interface -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-code"></i> SQL Query Editor
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <textarea id="sql-editor" placeholder="Enter your SQL query here..."></textarea>
                        </div>
                        <div class="d-flex gap-2 mb-3">
                            <button class="btn btn-primary" onclick="executeQuery()">
                                <i class="fas fa-play"></i> Execute Query
                            </button>
                            <button class="btn btn-outline-info" onclick="testConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-book"></i> Templates
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="loadTemplate('basic')">Basic SELECT</a></li>
                                <li><a class="dropdown-item" href="#" onclick="loadTemplate('aggregation')">Aggregation Query</a></li>
                                <li><a class="dropdown-item" href="#" onclick="loadTemplate('iceberg_partitions')">Iceberg Partitions</a></li>
                                <li><a class="dropdown-item" href="#" onclick="loadTemplate('time_series')">Time Series Analysis</a></li>
                            </ul>
                            <button class="btn btn-outline-secondary" onclick="clearQuery()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <button class="btn btn-outline-success" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                        
                        <!-- Query Results -->
                        <div id="query-results" style="display: none;">
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-table"></i> Query Results
                                <span id="result-count" class="badge bg-secondary ms-2"></span>
                            </h6>
                            <div class="query-results">
                                <div id="results-table"></div>
                            </div>
                        </div>

                        <!-- Query Status -->
                        <div id="query-status" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <span id="status-message">Query executed successfully</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script>
        // Initialize CodeMirror
        let editor = CodeMirror.fromTextArea(document.getElementById('sql-editor'), {
            mode: 'text/x-sql',
            theme: 'monokai',
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 4,
            lineWrapping: true
        });

        // Set default query
        editor.setValue(`SELECT *
FROM iceberg.analytics_analytics.raw_parking_data
LIMIT 10`);

        // Load catalogs on page load
        loadCatalogTree();

        function executeQuery() {
            const query = editor.getValue();
            if (!query.trim()) {
                alert('Please enter a SQL query');
                return;
            }

            // Show loading state
            document.getElementById('query-status').style.display = 'block';
            document.getElementById('status-message').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing query...';
            document.getElementById('query-results').style.display = 'none';

            // Execute query via API
            fetch('/api/query/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.results, data.columns);
                    document.getElementById('status-message').innerHTML = 
                        `<i class="fas fa-check-circle text-success"></i> Query executed successfully in ${data.execution_time}ms`;
                } else {
                    document.getElementById('status-message').innerHTML = 
                        `<i class="fas fa-exclamation-triangle text-warning"></i> Query failed: ${data.error}`;
                }
            })
            .catch(error => {
                document.getElementById('status-message').innerHTML = 
                    `<i class="fas fa-times-circle text-danger"></i> Error: ${error.message}`;
            });
        }

        function displayResults(results, columns) {
            const resultsDiv = document.getElementById('results-table');
            const countSpan = document.getElementById('result-count');
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="alert alert-info">No results returned</div>';
                countSpan.textContent = '0 rows';
            } else {
                let tableHtml = '<div class="table-responsive"><table class="table table-striped table-hover">';
                
                // Header
                tableHtml += '<thead><tr>';
                columns.forEach(col => {
                    tableHtml += `<th>${col}</th>`;
                });
                tableHtml += '</tr></thead>';
                
                // Body
                tableHtml += '<tbody>';
                results.forEach(row => {
                    tableHtml += '<tr>';
                    columns.forEach(col => {
                        tableHtml += `<td>${row[col] || ''}</td>`;
                    });
                    tableHtml += '</tr>';
                });
                tableHtml += '</tbody></table></div>';
                
                resultsDiv.innerHTML = tableHtml;
                countSpan.textContent = `${results.length} rows`;
            }
            
            document.getElementById('query-results').style.display = 'block';
        }

        function clearQuery() {
            editor.setValue('');
            document.getElementById('query-results').style.display = 'none';
            document.getElementById('query-status').style.display = 'none';
        }

        function testConnection() {
            // Show loading state
            document.getElementById('query-status').style.display = 'block';
            document.getElementById('status-message').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing connection...';
            document.getElementById('query-results').style.display = 'none';

            // Test with a simple query
            const testQuery = "SHOW CATALOGS";

            fetch('/api/query/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: testQuery })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('status-message').innerHTML =
                        `<i class="fas fa-check-circle text-success"></i> Connection successful! Found ${data.row_count} catalogs`;

                    // Show the catalogs
                    displayResults(data.results, data.columns);
                } else {
                    document.getElementById('status-message').innerHTML =
                        `<i class="fas fa-exclamation-triangle text-warning"></i> Connection test failed: ${data.error}`;
                }
            })
            .catch(error => {
                document.getElementById('status-message').innerHTML =
                    `<i class="fas fa-times-circle text-danger"></i> Connection error: ${error.message}`;
            });
        }

        // Dynamic catalog tree functions
        function loadCatalogTree() {
            const catalogTree = document.getElementById('catalog-tree');
            catalogTree.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-spinner fa-spin"></i> Loading catalogs...</div>';

            fetch('/api/catalogs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderCatalogTree(data.catalogs);
                    } else {
                        catalogTree.innerHTML = '<div class="alert alert-warning">Failed to load catalogs</div>';
                    }
                })
                .catch(error => {
                    catalogTree.innerHTML = `<div class="alert alert-danger">Error loading catalogs: ${error.message}</div>`;
                });
        }

        function refreshCatalogTree() {
            loadCatalogTree();
        }

        function renderCatalogTree(catalogs) {
            const catalogTree = document.getElementById('catalog-tree');
            let html = '';

            catalogs.forEach(catalog => {
                const catalogClass = catalog === 'iceberg' ? 'text-primary' : 'text-info';
                html += `
                    <div class="catalog-item p-2" data-catalog="${catalog}" onclick="toggleCatalog('${catalog}')">
                        <i class="fas fa-database ${catalogClass}"></i> <strong>${catalog}</strong>
                        <i class="fas fa-chevron-right float-end catalog-chevron" id="chevron-${catalog}"></i>
                    </div>
                    <div class="catalog-schemas" id="schemas-${catalog}" style="display: none;"></div>
                `;
            });

            catalogTree.innerHTML = html;
        }

        function toggleCatalog(catalog) {
            const schemasDiv = document.getElementById(`schemas-${catalog}`);
            const chevron = document.getElementById(`chevron-${catalog}`);

            if (schemasDiv.style.display === 'none') {
                // Load schemas
                schemasDiv.innerHTML = '<div class="text-center text-muted py-2"><i class="fas fa-spinner fa-spin"></i> Loading schemas...</div>';
                schemasDiv.style.display = 'block';
                chevron.className = 'fas fa-chevron-down float-end';

                fetch(`/api/catalogs/${catalog}/schemas`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderSchemas(catalog, data.schemas);
                        } else {
                            schemasDiv.innerHTML = '<div class="alert alert-warning ms-3">Failed to load schemas</div>';
                        }
                    })
                    .catch(error => {
                        schemasDiv.innerHTML = `<div class="alert alert-danger ms-3">Error loading schemas: ${error.message}</div>`;
                    });
            } else {
                schemasDiv.style.display = 'none';
                chevron.className = 'fas fa-chevron-right float-end';
            }
        }

        function renderSchemas(catalog, schemas) {
            const schemasDiv = document.getElementById(`schemas-${catalog}`);
            let html = '';

            schemas.forEach(schema => {
                html += `
                    <div class="catalog-item p-1 ms-3" data-schema="${schema}" onclick="toggleSchema('${catalog}', '${schema}')">
                        <i class="fas fa-folder text-warning"></i> ${schema}
                        <i class="fas fa-chevron-right float-end schema-chevron" id="chevron-${catalog}-${schema}"></i>
                    </div>
                    <div class="schema-tables" id="tables-${catalog}-${schema}" style="display: none;"></div>
                `;
            });

            schemasDiv.innerHTML = html;
        }

        function toggleSchema(catalog, schema) {
            const tablesDiv = document.getElementById(`tables-${catalog}-${schema}`);
            const chevron = document.getElementById(`chevron-${catalog}-${schema}`);

            if (tablesDiv.style.display === 'none') {
                // Load tables
                tablesDiv.innerHTML = '<div class="text-center text-muted py-2 ms-4"><i class="fas fa-spinner fa-spin"></i> Loading tables...</div>';
                tablesDiv.style.display = 'block';
                chevron.className = 'fas fa-chevron-down float-end';

                fetch(`/api/catalogs/${catalog}/schemas/${schema}/tables`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderTables(catalog, schema, data.tables);
                        } else {
                            tablesDiv.innerHTML = '<div class="alert alert-warning ms-4">Failed to load tables</div>';
                        }
                    })
                    .catch(error => {
                        tablesDiv.innerHTML = `<div class="alert alert-danger ms-4">Error loading tables: ${error.message}</div>`;
                    });
            } else {
                tablesDiv.style.display = 'none';
                chevron.className = 'fas fa-chevron-right float-end';
            }
        }

        function renderTables(catalog, schema, tables) {
            const tablesDiv = document.getElementById(`tables-${catalog}-${schema}`);
            let html = '';

            tables.forEach(table => {
                html += `
                    <div class="catalog-item p-1 ms-4" data-table="${table}" onclick="selectTable('${catalog}', '${schema}', '${table}')">
                        <i class="fas fa-table text-success"></i> ${table}
                    </div>
                `;
            });

            tablesDiv.innerHTML = html;
        }

        function selectTable(catalog, schema, table) {
            // Remove active class from all items
            document.querySelectorAll('.catalog-item').forEach(item => item.classList.remove('active'));

            // Add active class to selected table
            event.target.closest('.catalog-item').classList.add('active');

            // Insert table name into query editor
            const tableName = `${catalog}.${schema}.${table}`;
            const cursor = editor.getCursor();
            editor.replaceRange(tableName, cursor);
            editor.focus();

            // Load table metadata
            loadTableMetadata(catalog, schema, table);
        }

        function loadTableMetadata(catalog, schema, table) {
            const metadataPanel = document.getElementById('metadata-panel');
            const metadataContent = document.getElementById('metadata-content');

            metadataPanel.style.display = 'block';
            metadataContent.innerHTML = '<div class="text-center text-muted"><i class="fas fa-spinner fa-spin"></i> Loading metadata...</div>';

            fetch(`/api/catalogs/${catalog}/schemas/${schema}/tables/${table}/metadata`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderTableMetadata(data.metadata, table);
                    } else {
                        metadataContent.innerHTML = '<div class="alert alert-warning">Failed to load metadata</div>';
                    }
                })
                .catch(error => {
                    metadataContent.innerHTML = `<div class="alert alert-danger">Error loading metadata: ${error.message}</div>`;
                });
        }

        function renderTableMetadata(metadata, tableName) {
            const metadataContent = document.getElementById('metadata-content');
            let html = `<h6 class="mb-3"><i class="fas fa-table"></i> ${tableName}</h6>`;

            // Row count
            if (metadata.row_count !== undefined) {
                html += `
                    <div class="mb-3">
                        <strong>Row Count:</strong> ${metadata.row_count.toLocaleString()}
                    </div>
                `;
            }

            // Columns
            if (metadata.columns && metadata.columns.length > 0) {
                html += `
                    <div class="mb-3">
                        <strong>Columns (${metadata.columns.length}):</strong>
                        <div class="mt-2" style="max-height: 200px; overflow-y: auto;">
                `;

                metadata.columns.forEach(column => {
                    const colName = column.Column || column.column || 'Unknown';
                    const colType = column.Type || column.type || 'Unknown';
                    html += `<div class="small text-muted"><code>${colName}</code> - ${colType}</div>`;
                });

                html += '</div></div>';
            }

            // Partitions (for Iceberg tables)
            if (metadata.partitions && metadata.partitions.length > 0) {
                html += `
                    <div class="mb-3">
                        <strong>Partitions (${metadata.partitions.length}):</strong>
                        <div class="mt-2" style="max-height: 150px; overflow-y: auto;">
                            <small class="text-muted">Partition information available</small>
                        </div>
                    </div>
                `;
            }

            metadataContent.innerHTML = html;
        }

        function loadTemplate(template) {
            const templates = {
                'basic': `SELECT *
FROM iceberg.analytics_analytics.raw_parking_data
LIMIT 10`,
                'aggregation': `SELECT
    location_name,
    COUNT(*) as record_count,
    ROUND(AVG(available_spaces), 2) as avg_available_spaces,
    ROUND(AVG(utilization_percentage), 2) as avg_utilization
FROM iceberg.analytics_analytics.live_parking
GROUP BY location_name
ORDER BY avg_utilization DESC
LIMIT 10`,
                'iceberg_partitions': `SELECT
    partition,
    record_count,
    file_count,
    total_size
FROM iceberg.analytics_analytics.raw_parking_data$partitions
ORDER BY record_count DESC`,
                'time_series': `SELECT
    DATE_TRUNC('hour', CAST(fetched_at AS TIMESTAMP)) as hour,
    COUNT(*) as readings_count,
    ROUND(AVG(utilization_percentage), 2) as avg_utilization,
    ROUND(STDDEV(utilization_percentage), 2) as utilization_stddev
FROM iceberg.analytics_analytics.live_parking
WHERE fetched_at >= CURRENT_TIMESTAMP - INTERVAL '24 hours'
GROUP BY DATE_TRUNC('hour', CAST(fetched_at AS TIMESTAMP))
ORDER BY hour DESC`
            };

            if (templates[template]) {
                editor.setValue(templates[template]);
            }
        }

        function exportResults() {
            const resultsDiv = document.getElementById('results-table');
            if (resultsDiv.style.display === 'none') {
                alert('No results to export');
                return;
            }
            
            // Simple CSV export
            const table = resultsDiv.querySelector('table');
            if (table) {
                const csv = tableToCSV(table);
                downloadCSV(csv, 'query_results.csv');
            }
        }

        function tableToCSV(table) {
            const rows = table.querySelectorAll('tr');
            let csv = [];
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = Array.from(cols).map(col => {
                    let text = col.textContent || col.innerText;
                    text = text.replace(/"/g, '""');
                    return `"${text}"`;
                });
                csv.push(rowData.join(','));
            });
            
            return csv.join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
